# Take in a list of CNs to search for and a file to push them out to
# will find each of the CNs and iterate through each of the properies in each result
# Each property name and value will be output to the outfile
$filterFile = $args[0]
$outFile = $args[1]
Foreach ($filter in gc $filterFile)
{
	$filter >> $outFile
	$ldapfilter = "(CN=*$filter*)"
	$domain = New-Object System.DirectoryServices.DirectoryEntry
	$search = New-Object System.DirectoryServices.DirectorySearcher
	$search.SearchRoot = $domain
	$search.PageSize = 1000
	$search.Filter = $ldapFilter
	$search.SearchScope = "Subtree"
	$results = $search.FindAll()
	foreach ($result in $results)
	{
		$userEntry = $result.GetDirectoryEntry()
		foreach ($SPN in $userEntry.PSObject.Properties)
		{
			try
			{
				$theName = $SPN.Name.toString() -replace "`n","" -replace "`r",""
			}
			catch
			{
				$theName = ''
			}
			
			try
			{
				$theValue = $SPN.Value.toString() -replace "`n","" -replace "`r",""
			}
			catch
			{
				$theValue = ''
			}
			
			Write-Output "$theName ---> $theValue" >> $outFile
		}
	}
	Write-Output "`r`n" >> $outFile
	"****************************" >> $outFile
	Write-Output "`r`n" >> $outFile
}
