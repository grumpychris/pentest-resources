# Meteor JS specific testing considerations
[Meteor](https://www.meteor.com/) "is an open source platform for seamlessly building and deploying Web, Mobile, and Desktop applications in Javascript or TypeScript."[sic]

When testing Meteor there are some issues caused by the fact the application runs almost entirely via web sockets. There are also some helper functions and object values available in the client browser which can be useful.

This document is based on two guides and the [Meteor documentation](https://docs.meteor.com/) as well as a bunch of tinkering:
- [Octal Security's "Security Review for Meteor JS Applications"](https://octalsecurity.io/blog/security-review-for-meteor-js-applications/)
- [Gremwell's Pentesting Meteor Application with Burp Suite](https://www.gremwell.com/blog/pentesting-meteor-applications-with-burp-suite)  

## Testing Issues
The primary issue with testing a Meteor app is the reliance on web sockets. The framework uses their own wrapper around SockJS called Distributed Data Protocol (DDP). The usual tools such as [Burp Suite](https://portswigger.net/burp/pro) and [Zap](zaproxy.org) don't play well with web sockets, making interception and replay of messages problematic.  

## Review the source code
Even if testing is black box client application only, it is a good idea to review the source code in some detail. Meteor doesn't automatically differentiate the server and client code. In fact there are inline tests "isServer" and "isClient" the developers can use to differentiate on the fly and make code reuse easier between the two. This means it is easy for a developer to inadvertently publish server side code to the clients. An example seen in the wild is code to inject test users into the database being published in clear text in the client app.

## Routes
The concept of a route is different in Meteor, again because of the use of web sockets rather than HTTP requests. Of primary interest for testing, Meteor has "methods" and "subscriptions". You can call a method or subscribe to a subscription.
To find methods search for **Methods({** in the source code. You will find various methods which are then linked with functions like a route in a HTTP based web application.
Subscriptions are "published" and can be found in the source code by searching for **publish("**.

## Interaction
Due to the issues with Burp and Zap, dealing with methods and subscriptions is easiest directly from the browser console. To call a method you can use:  
```Meteor.call('method', (err, res) => {console.log(res);})```  

To subscribe to a subscription you can try:   
```Meteor.connection._stream.send('{"msg":"sub","id":"UNIQUEID","name":"subscriptionName","params":[{"param1":"value"}]}');```  
where the UNIQUEID must be new each request. Depending on the subscription, this should get you the items associated returned in individual messages, one per item (yes, it is painful when it's a long list).

It's also possible to use the _stream.send function to call methods, but it's more complicated.

## Seeing Web Socket traffic
You can see the web socket traffic in your Burp or Zap proxy, but to see it real time in the browser console you can run the following code in the console which will output each 'message' sent or received. The code could use some work, but it does enough to get started. It is based on code from Gremwell's blog linked above. 
```
$(document).ready(function() {
  self.Meteor = Package.meteor.Meteor;
  var oldSend = Meteor.connection._stream.send;
  self.Meteor.connection._stream.send = function() {
      var msg = arguments[0];
      console.log("******** DDPLog Send:"+msg);
  oldSend.apply(this, arguments);
  };
});

Meteor.connection._stream.on('message', function (msg) {
  console.log("******** Message: " + msg);
});
```  
You will get a "DDPLog Send" output for each manually run _stream.send actions plus a "Message" output for all web socket messages.

## Chrome Extensions
As with many JS frameworks there is a chrome developer extension for Meteor. The extension "Meteor DevTools Evolved" will show you the web socket messages being sent and received and some other potentially useful data. It is not an official extension, being developed by an independent party [Leonardo Venturini](https://github.com/leonardoventurini/meteor-devtools-evolved)