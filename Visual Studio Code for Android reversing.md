# Setup and Use of Windows with VS Code for Reversing Android APKs
## Intro
As a beginner APK reverser I found almost all instructions and tutorials were for Linux or MacOS (or even OS X). The problem I faced is my testing laptop is Windows and 
Android Emulator doesn't work well (at all?) in a VM. So, I needed a way to reverse APKs on my Windows box. Initially I was doing the decompiling and recompiling work 
in Kali and then copying the APK to Windows to test it in the emulator. This was painful as you can probably imagine. An extra difficulty was introduced by the fact I 
don't have Administrator rights on the laptop.  

This document is the end result of some trial and error to get my environment set up and usable in Windows only.

## Requirements
### [Android Studio](https://developer.android.com/studio)
Android Studio is needed for the emulator and the SDK. The Studio itself is helpful if you have all the source code, but if you've only got an APK it's not a lot of help.
Android Studio requires Administrator rights to install. This is the only software I use which I couldn't install myself.

### [Visual Studio Code](https://code.visualstudio.com/)
Visual Studio Code has fast become my favourite IDE (not counting vim of course ðŸ˜‰ ). It isn't set up to work with Java or Android out of the box, 
but the number of extensions available make it useful for almost any coding task.

### [APKLab Extension](https://github.com/APKLab/APKLab)
This extension for VS Code installs all the necessary tools for decompiling, recompiling and signing APKs, as well as a bunch of other functionality. It serves as a 
wrapper to a number of different stand-alone command line tools such as jadx, apktools etc. It is installed via the Extensions marketplace for VS Code, but is 
free and has a useful wiki on its github site.

### [JDK](https://www.microsoft.com/openjdk)
I went with the Microsoft JDK, because <insert word here> Oracle. There are others, but the MS one has a zip file for install without Administrator rights and an msi
for those who actually control their machine. If you install this from the zip you will need to add a JAVA_HOME environment variable with the path to your JDK folder.
  
### Path settings
You need to add both JDK's bin folder (in your JAVA_HOME) and the Android SDK platform-tools folder to your PATH environment variable.
  
## The Basic Process
The process of using this setup for basic reversing tasks is fairly straight forward. I can't speak for complex tasks because I haven't been in the game long enough. 
APKLab outlines the process in 5 basic steps which I will flesh out a little here.

### Import the APK
In VS Code press <ctrl>-<shift>-P to open your list of available commands. One of the commands is `APKLab: Open and APK`. Select this and browse to your APK. 
  When you open your APK there are a few options available, mostly around the apktool and jadx command line flags. I recommend 
  - `decompile_java` - As it's name suggests, decompile to Java as well as smali making the code easier to review. You can't recompile from the java though!
  - `--no-res` - Don't decompile the resources. Makes recompiling more likely to succeed.
  - `--only-main-classes`. Only decompile the classesXX.dex files. YMMV

### Review and Edit the Code
You can review the Java code and edit the smali. VS Code will let you edit the Java, but when you recompile the APK these changes are ignored, only smali changes effect
  the code in the APK. smali feels halfway between assembly and Java code. It isn't intuitive for me, so having the Java along-side makes it easier to follow.
  
### Prepare for HTTPS Inspection
APKLab will call apk-mitm to attempt to patch out certificate pinning. I haven't tested this yet, so buyer beware.
  
### Rebuild the APK
  Recompile and sign the APK, including the changes you have made in the code.
  
### Install the APK
  If adb debugging is working for you, APKLab will push the recompiled app to your device of choice (Android Emulator in my case).
  
## Extras
  A few little extra notes, thoughts and tools to help

### adb
  adb, or Android Debug Bridge, is a client-server interface between a PC and an Android device, whether that is a physical device or an emulator. adb is a powerful tool in 
  its own right and if you are doing any work with Android I recommend getting your head around the basics of using it. It is good for development, reversing and even forensic
  work
  
### logcat
adb includes a useful feature called logcat. It basically just streams the logs from the device being debugged, like dmesg or journalctl in Linux land. It allows
  you to do every developers favourite debug trick, println, without having to mess around with contexts, toasts, activities etc in smali.
  
### [Android Package Index](https://developer.android.com/reference/packages)
The Android developers documentation with details of the various packages available in an APK, including java classes and types you can use.
  
### [OWASP Crackme Challenges](https://github.com/OWASP/owasp-mstg/tree/master/Crackmes)
A set of CTF exercises put together by the OWASP Mobile Testing Group. Useful for us noobs to get our head around the basics.
  
