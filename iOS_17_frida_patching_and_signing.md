# iOS 17 IPA resign and install for non-Jailbroken iPhone
This process requires a Mac and has only been tested on MacOS Sonoma on an M3 Macbook Pro with an iPhone 15 Plus  

## Prep
- Obtain IPA
- Install Xcode (from apple app store)
- Register for apple developer account (Free is fine)
- Install homebrew (```/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"```)
- Install Python (from python.org website)
- Install node and npm (```brew install node```)
- Install applesign (```npm install -g applesign```)
- Install insert_dylib (
```
git clone https://github.com/Tyilo/insert_dylib.git
cd insert_dylib
xcrun clang -x c ./insert_dylib/main.c -I/usr/include/ -o insert-dylib
sudo cp build/Release/insert_dylib /usr/local/bin/
```
)
- Install Frida ```python3 -m pip install frida```
- Install Objection ```python3 -m pip install objection```
- Download frida dylib file (browse to https://github.com/frida/frida/releases and grab frida-gadget-&lt;version>-ios-universal.dylib.gz)
- Install pymobiledevice3 (```python3 -m pip install pymobiledevice3```)

## Put iPhone in Developer Mode and get mobileprovision file and Bundle ID (required for signing)
more details but a bit out of date can be seen here: https://github.com/sensepost/objection/wiki/Patching-iOS-Applications
### Create Blank App
- Open Xcode and sign in to your developer account (Xcode --> settings --> Accounts --> plus sign in bottom right)  
- Create a new app (Open Xcode --> File --> new --> project).
  - In the "Choose a template for your new project" window select iOS in the top bar and App under "Application"  
  - In the "Choose options for your new project" window name the app anything (will potentially be visible to clients if doing a pentest!)  
- Under "Team" choose your developer ID  
- Click next  
- Project will create and a blank single page "Hello world!" app will be ready to go  

### Associate Device and get Bundle ID
- Connect iPhone to the Mac with a cable
- In the top bar of Xcode on the Mac with the new App open, select the mobile device  (appname has a white arrow next to it with the available devices in a drop down to the right)
  - If the device is not available it is not connected or needs to be put in developer mode
  - To put device in developer mode, with Xcode open:
    - unlock the phone (Accept the attachment of devices/accessories prompt if required)
    - open settings
    - open privacy and security
    - scroll to the bottom
    - select developer mode
    - click the slide toggle to turn on
    - The device will need to reboot
    - Unlock device after reboot
    - accept the prompt to turn developer mode on
- Once developer mode is enabled, open the "Manage Run Destinations" window in Xcode on the Mac (where you choose the target device, at the bottom of the list menu is a "Manage Run Destinations..." option)
- In the window copy/note the "Identifier" value for the device you're targetting then close the window
- Unlock the iPhone
- Click the play button (triangle next to the app name in the top bar) to build and push the application (this is needed to create the mobileprovision file)
- iPhone will prompt that the developer is not trusted:
  - Open settings on the iPhone
  - Select general
  - Scroll down to VPN & Device Management
  - Under "DEVELOPER APP" tap the "Apple Development: &lt;APPLE-ID>"
  - Tap the Trust "Apple Development: &lt;APPLE-ID>" link
  - Tap "Trust"
- To locate the provision file, run the following command on the Mac: ```find / -type f -iname '*.mobileprovision' 2>/dev/null``` 
- It will be somewhere like: /Users/&lt;USERNAME>/Library/Developer/Xcode/DerivedData/&lt;APP-NAME>-&lt;RANDOM-STRING>/Build/Products/Debug-iphoneos/&lt;APP-NAME>.app/embedded.mobileprovision  
- To get the bundle id run the following command: ```security cms -D -i <MOBILEPROVISION-FILE-PATH> | plutil -extract Entitlements.application-identifier xml1 -o - - | grep string | sed 's/^<string>[^\.]*\.\(.*\)<\/string>$/\1/g'```

## Patch IPA to insert frida dylib and sign new IPA
You'll need the code-sign signature identity from the developer account:  
```security find-identity -v | cut -d' ' -f4``` - if you've got more than one, just pick one  
The easiest way to patch the ipa and sign it in one is to use objection:  
```objection patchipa --source <IPA-FILE-PATH> --codesign-signature <CODE-SIGN-SIGNATURE-IDENTITY>```  
If that doesn't work, you'll need to use applesign manually:  
Note: try without the --without-plugins and --without-watchapp flags first. If they are the issue when you go to install it there will be an error relating to plugins or watchapp from xcrun  
```applesign --mobileprovision <PATH-TO-MOBILEPROVISION-FILE> --identity <CODE-SIGN-SIGNATURE-IDENTITY> --all <IPA-PATH> --bundleid <BUNDLE-ID> --self-sign-provision --verify-twice --clone-entitlements --without-plugins --without-watchapp --insert <FRIDA-DYLIB-PATH>``` 

## Install the new IPA
This is where you'll find out if the signing worked  
```xcrun devicectl device install app --device <IPHONE-DEVICE-ID> <PATCHED-IPA-PATH>```  

## Connect to frida server
Run the app in paused state:  
```xcrun devicectl device process launch --start-stopped --device <IPHONE-DEVICE-ID> <BUNDLE-ID>```  
To connect to the frida server now requires some port forwarding on the iPhone with pymobiledevice3  
```sudo pymobiledevice3 usbmux forward 27042 27042```  
Then connect with frida or objection:  
```frida -H 127.0.0.1:27042 <IPA-GENUINE-APP-NAME>```  
```objection -N -h 127.0.0.1 -p 27042 -g <IPA-GENUINE-APP-NAME> explore```  

### Sources:
- https://github.com/sensepost/objection/wiki/Patching-iOS-Applications
- https://github.com/frida/frida/issues/2663
- https://stackoverflow.com/questions/66820374/how-to-extract-the-bundle-identifier-from-a-provisioning-profile
- https://github.com/nowsecure/node-applesign/issues/128
